# Dockerfile (multi-stage) — Maven
ARG MAVEN_IMAGE=eclipse-temurin:17-jdk-alpine
ARG RUNTIME_IMAGE=eclipse-temurin:17-jre-alpine

FROM ${MAVEN_IMAGE} AS build
WORKDIR /app

COPY . .

# Запускаем сборку (предполагается, что используется Maven)
RUN  ./mvnw clean package -DskipTests

FROM eclipse-temurin:17-jre-alpine
WORKDIR /app

# Копируем собранный JAR из стадии сборки
COPY --from=build /app/target/*.jar app.jar

# Создаем непривилегированного пользователя для безопасности
RUN addgroup -S spring && adduser -S spring -G spring
USER spring

# Открываем порт
EXPOSE 5000

ENV SPRING_PROFILES_ACTIVE=prod
ENV SERVER_PORT=5000

# Запускаем приложение
ENTRYPOINT ["java", "-jar", "app.jar"]